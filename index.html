<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>the empire of chronicles</title>
    <link href="https://fonts.googleapis.com/css2?family=playfair+display&family=source+sans+pro:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <link rel="icon" type="image/png" href="empire-icon.png">
    <style>
      :root {
        --bg: #fdfaf3;
        --text: #2d2d2d;
        --subtle: #e0dcd3;
        --accent: #d4af37;
        --primary: #8b5e3c;
        --secondary-bg: #f9f5ec;
        --card-shadow: rgba(0, 0, 0, 0.1);
        --hover: rgba(139, 94, 60, 0.1);
        --code-bg: #f5f0e6;
        --header-bg: #fff8f0;
        --nav-border: #d4af37;
      }
      [data-theme="dark"] {
        --bg: #1a1a1a;
        --text: #f5f5f5;
        --subtle: #333333;
        --accent: #d4af37;
        --primary: #b8860b;
        --secondary-bg: #222222;
        --card-shadow: rgba(0, 0, 0, 0.3);
        --hover: rgba(184, 134, 11, 0.2);
        --code-bg: #2a2a2a;
        --header-bg: #222222;
        --nav-border: #d4af37;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: 'source sans pro', sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        background: var(--bg);
        color: var(--text);
        transition: all 0.3s ease;
      }
      h1, h2, h3, h4, h5 {
        font-family: 'playfair display', serif;
        margin-bottom: 0.5em;
        color: var(--primary);
      }
      /* header */
      .header {
        background: var(--header-bg);
        padding: 16px 20px;
        border-bottom: 2px solid var(--nav-border);
        margin-bottom: 24px;
      }
      .nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .nav .logo {
        font-size: 28px;
        font-weight: 600;
        letter-spacing: -0.5px;
      }
      .nav ul {
        list-style: none;
        display: flex;
        gap: 20px;
      }
      .nav ul li a {
        text-decoration: none;
        color: var(--primary);
        font-weight: 600;
        transition: color 0.2s;
      }
      .nav ul li a:hover {
        color: var(--accent);
      }
      /* hero section */
      .hero {
        text-align: center;
        margin-bottom: 40px;
      }
      .hero p {
        font-size: 18px;
        margin-top: 12px;
        color: var(--accent);
      }
      /* controls and search */
      .controls {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-bottom: 24px;
      }
      .controls button {
        background: none;
        border: 1px solid var(--subtle);
        color: var(--text);
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background 0.2s;
      }
      .controls button:hover {
        background: var(--hover);
      }
      .search-container {
        position: relative;
        display: none;
      }
      #search-input {
        border: 1px solid var(--subtle);
        padding: 8px 36px 8px 12px;
        font-size: 14px;
        border-radius: 4px;
        background: var(--bg);
        color: var(--text);
        width: 200px;
      }
      #search-input:focus {
        outline: none;
        border-color: var(--primary);
      }
      .clear-search {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        font-size: 14px;
        color: var(--accent);
        cursor: pointer;
      }
      /* bio section */
      .bio {
        border: 2px solid var(--subtle);
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 32px;
        background: var(--secondary-bg);
      }
      .bio a {
        color: var(--primary);
        text-decoration: none;
      }
      .bio a:hover {
        text-decoration: underline;
      }
      .bio-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .bio-toggle {
        background: none;
        border: none;
        color: var(--accent);
        cursor: pointer;
        font-size: 14px;
      }
      .bio-content {
        margin-top: 16px;
        display: none;
      }
      .bio-content ul {
        list-style: disc inside;
        margin-top: 8px;
      }
      /* stats */
      .stats {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: var(--subtle);
        margin-bottom: 20px;
      }
      /* post editor */
      #editor {
        margin-bottom: 40px;
        display: none;
      }
      #editor textarea {
        width: 100%;
        height: 150px;
        padding: 12px;
        border: 1px solid var(--subtle);
        border-radius: 4px;
        font-family: inherit;
        font-size: 16px;
        background: var(--bg);
        color: var(--text);
        resize: vertical;
        transition: all 0.2s;
      }
      #editor textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px var(--hover);
      }
      .editor-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
      }
      .editor-actions span {
        font-size: 14px;
        color: var(--subtle);
      }
      .editor-actions button {
        background: var(--primary);
        border: none;
        color: #fff;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: opacity 0.2s;
      }
      .editor-actions button:hover {
        opacity: 0.9;
      }
      /* live preview */
      .draft-preview {
        border: 2px dashed var(--subtle);
        padding: 16px;
        margin-top: 20px;
        border-radius: 4px;
        background: var(--secondary-bg);
        opacity: 0.9;
      }
      .draft-header {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: var(--subtle);
        margin-bottom: 8px;
      }
      /* posts */
      .post {
        border: 2px solid var(--subtle);
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 32px;
        background: var(--secondary-bg);
        box-shadow: 0 3px 6px var(--card-shadow);
        transition: box-shadow 0.3s;
      }
      .post:hover {
        box-shadow: 0 6px 12px var(--card-shadow);
      }
      .post-header {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        margin-bottom: 12px;
        color: var(--subtle);
      }
      .post-header button {
        background: none;
        border: 1px solid var(--subtle);
        color: var(--primary);
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .post-header button:hover {
        background: var(--hover);
      }
      .post-content p {
        margin-bottom: 1em;
        line-height: 1.7;
      }
      .post-content a {
        color: var(--primary);
        text-decoration: none;
      }
      .post-content a:hover {
        text-decoration: underline;
      }
      .post-content pre {
        background: var(--code-bg);
        padding: 12px;
        border-radius: 4px;
        overflow-x: auto;
        margin: 1em 0;
      }
      .post-content code {
        font-family: 'source sans pro', monospace;
        font-size: 0.9em;
      }
      /* notifications */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--primary);
        color: #fff;
        padding: 12px 24px;
        font-size: 14px;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: none;
        animation: slide-in 0.3s ease-out;
        z-index: 100;
      }
      @keyframes slide-in {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      /* live indicator */
      .live-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(90deg, rgba(212,175,55,0.1) 0%, rgba(212,175,55,0.15) 100%);
        color: var(--text);
        text-align: center;
        padding: 10px;
        font-weight: 600;
        backdrop-filter: blur(5px);
        border-bottom: 2px solid var(--nav-border);
        display: none;
        z-index: 1000;
      }
      .live-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        background: var(--accent);
        border-radius: 50%;
        margin-right: 8px;
        animation: blink 1.5s infinite;
      }
      @keyframes blink {
        0% { opacity: 0.4; }
        50% { opacity: 1; }
        100% { opacity: 0.4; }
      }
      /* responsive */
      @media (max-width: 700px) {
        body { padding: 16px; }
        .nav ul { gap: 12px; }
        #search-input { width: 160px; }
      }
    </style>
  </head>
  <body>
    <div class="live-bar" id="live-bar">
      <span class="live-dot"></span> sharvesh is composing a new decree...
    </div>

    <header class="header">
      <nav class="nav">
        <div class="logo">the empire</div>
        <ul>
          <li><a href="#">home</a></li>
          <li><a href="#">chronicles</a></li>
          <li><a href="#">legacies</a></li>
          <li><a href="#">about</a></li>
        </ul>
      </nav>
    </header>

    <section class="hero">
      <h1>the grand chronicles</h1>
      <p>where words rule and destiny is penned</p>
    </section>

    <div class="controls">
      <button onclick="toggle_search()" title="search chronicles">🔍</button>
      <div class="search-container" id="search-container">
        <input type="text" id="search-input" placeholder="search chronicles..." onkeyup="search_posts(this.value)">
        <button class="clear-search" id="clear-search" onclick="clear_search()" title="clear search">✕</button>
      </div>
      <button onclick="toggle_theme()" id="theme-toggle" title="toggle theme">🌙</button>
      <button id="login-btn" onclick="login()" title="admin login">login</button>
      <button id="logout-btn" onclick="logout()" title="logout" style="display:none">logout</button>
    </div>

    <div class="bio">
      <div class="bio-header">
        <p>conscript. writing at <a href="https://www.sharvesh.com/" target="_blank">sharvesh.com</a></p>
        <button class="bio-toggle" id="bio-toggle" onclick="toggle_bio()">more ▼</button>
      </div>
      <div class="bio-content" id="bio-content">
        <h2>fav tomes</h2>
        <ul>
          <li>elon musk, steve jobs, kissinger by walter isaacson</li>
          <li>the years of lyndon johnson by robert caro</li>
          <li>napoleon by andrew roberts</li>
          <li>alexander hamilton, titan by ron chernow</li>
          <li>the patriarch by david nasaw</li>
          <li>the theodore roosevelt trilogy by edmund morris</li>
          <li>total recall by arnold schwarzenegger</li>
          <li>the singapore story by lee kuan yew</li>
          <li>hpmor by eliezer yudkowsky</li>
        </ul>
        <h4>@sharvenium everywhere</h4>
      </div>
    </div>

    <div class="stats" id="stats">
      <span id="total-posts">total posts: 0</span>
      <span id="today-posts">posts today: 0</span>
      <span id="word-count">total words: 0</span>
    </div>

    <div id="editor">
      <textarea id="post-input" placeholder="compose your decree... markdown enabled..." oninput="handle_typing(event)"></textarea>
      <div class="editor-actions">
        <span id="char-count">0 characters</span>
        <button onclick="publish_post(true)">publish decree</button>
      </div>
      <div class="draft-preview">
        <div class="draft-header">
          <span>live preview</span>
          <span id="save-status"></span>
        </div>
        <div id="live-draft-preview"></div>
      </div>
    </div>

    <div id="timeline"></div>

    <div class="toast" id="toast"></div>

    <script>
      let auth0client = null;
      let posts = [];
      let isdark = localStorage.getItem('theme') === 'dark';
      let currentdraft = null;
      let typingtimeout = null;
      let liveindicatortimeout = null;
      let searchactive = false;

      if (isdark) {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('theme-toggle').textContent = '☀️';
      }

      marked.setOptions({
        breaks: true,
        gfm: true,
        highlight: function(code, lang) {
          if (hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
          }
          return code;
        }
      });

      function toggle_search() {
        const container = document.getElementById('search-container');
        searchactive = !searchactive;
        container.style.display = searchactive ? 'block' : 'none';
        if (searchactive) {
          document.getElementById('search-input').focus();
        } else {
          clear_search();
        }
      }

      function clear_search() {
        document.getElementById('search-input').value = '';
        search_posts('');
      }

      function toggle_bio() {
        const bio = document.getElementById('bio-content');
        const btn = document.getElementById('bio-toggle');
        if (bio.style.display === 'block') {
          bio.style.display = 'none';
          btn.innerHTML = 'more ▼';
        } else {
          bio.style.display = 'block';
          btn.innerHTML = 'less ▲';
        }
      }

      function show_live_indicator(show) {
        const livebar = document.getElementById('live-bar');
        livebar.style.display = show ? 'block' : 'none';
        document.body.classList.toggle('live-mode', show);
      }

      function init_presence() {
        const db = firebase.database();
        const userref = db.ref('presence/sharvesh');
        const offline = {
          state: 'offline',
          lastchanged: firebase.database.ServerValue.TIMESTAMP
        };
        const online = {
          state: 'online',
          lastchanged: firebase.database.ServerValue.TIMESTAMP
        };

        auth0client.isAuthenticated().then(isauthenticated => {
          if (isauthenticated) {
            auth0client.getUser().then(user => {
              if (user.email === "sharvenium@gmail.com") {
                db.ref('.info/connected').on('value', snap => {
                  if (!snap.val()) {
                    userref.set(offline);
                    return;
                  }
                  userref.onDisconnect().set(offline).then(() => {
                    userref.set(online);
                  });
                });
              }
            });
          }
        });

        userref.on('value', snapshot => {
          const val = snapshot.val();
          if (!val) return;
          // (optional) update any presence indicators if needed
        });
      }

      function init_draft_viewer() {
        const db = firebase.database();
        db.ref('drafts/sharvesh').on('value', snapshot => {
          const data = snapshot.val();
          const draftel = document.getElementById('live-draft-preview');
          const savestatus = document.getElementById('save-status');
          if (!data) {
            draftel.innerHTML = '';
            savestatus.textContent = '';
            return;
          }
          draftel.innerHTML = marked.parse(data.content);
          draftel.querySelectorAll('pre code').forEach(block => {
            hljs.highlightElement(block);
          });
          const now = new Date();
          const timestamp = new Date(data.timestamp);
          const diff = Math.floor((now - timestamp) / 1000);
          if (diff < 60) {
            savestatus.textContent = `saved ${diff}s ago`;
          } else {
            savestatus.textContent = `saved at ${timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
          }
        });
      }

      async function handle_typing(event) {
        const isauthenticated = await auth0client.isAuthenticated();
        if (!isauthenticated) return;
        const charcount = document.getElementById('char-count');
        charcount.textContent = `${event.target.value.length} characters`;
        clearTimeout(typingtimeout);
        clearTimeout(liveindicatortimeout);
        const db = firebase.database();
        db.ref('typingstatus').set({ iswriting: true, timestamp: Date.now() });
        const newcontent = event.target.value;
        db.ref('drafts/sharvesh').set({
          content: newcontent,
          timestamp: Date.now()
        });
        typingtimeout = setTimeout(async () => {
          const content = newcontent.trim();
          if (!content) {
            db.ref('drafts/sharvesh').remove();
            if (currentdraft) {
              await db.ref(`posts/${currentdraft}`).remove();
              currentdraft = null;
            }
            db.ref('typingstatus').set({ iswriting: false, timestamp: Date.now() });
            return;
          }
          if (!currentdraft) {
            const ref = await db.ref('posts').push({
              content: content,
              timestamp: Date.now(),
              isdraft: true
            });
            currentdraft = ref.key;
          } else {
            await db.ref(`posts/${currentdraft}`).update({
              content: content,
              timestamp: Date.now()
            });
          }
          db.ref('typingstatus').set({ iswriting: false, timestamp: Date.now() });
        }, 1000);
        liveindicatortimeout = setTimeout(() => {
          db.ref('typingstatus').set({ iswriting: false, timestamp: Date.now() });
        }, 5000);
      }

      function setup_typing_listener() {
        const db = firebase.database();
        db.ref('typingstatus').on('value', snapshot => {
          const status = snapshot.val();
          if (!status) return;
          show_live_indicator(status.iswriting);
        });
      }

      async function init_auth0() {
        try {
          auth0client = await auth0.createAuth0Client({
            domain: 'dev-kaixuri5eyviz2vm.us.auth0.com',
            client_id: 'z97keo08fomauocmmopfglaib0obi1k2',
            authorizationParams: { redirect_uri: window.location.origin }
          });
          if (window.location.search.includes("code=")) {
            await auth0client.handleRedirectCallback();
            window.history.replaceState({}, document.title, window.location.pathname);
          }
          update_ui();
        } catch (e) {
          console.error("auth0 init error:", e);
          show_toast("authentication error");
        }
      }

      function init_firebase() {
        const firebaseconfig = {
          apiKey: "AIzaSyASOSvCtoOddTRUdqzxVtCBcyfJ82SsEc0",
          authDomain: "twitterblog-9e7ea.firebaseapp.com",
          databaseURL: "https://twitterblog-9e7ea-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "twitterblog-9e7ea",
          storageBucket: "twitterblog-9e7ea.firebasestorage.app",
          messagingSenderId: "564254133364",
          appId: "1:564254133364:web:e89a32517db54517369521"
        };
        firebase.initializeApp(firebaseconfig);
        load_posts();
      }

      async function update_ui() {
        try {
          const isauthenticated = await auth0client.isAuthenticated();
          if (isauthenticated) {
            const user = await auth0client.getUser();
            console.log('logged in as:', user.email);
            if (user.email === "sharvenium@gmail.com") {
              document.getElementById('login-btn').style.display = 'none';
              document.getElementById('logout-btn').style.display = 'block';
              document.getElementById('editor').style.display = 'block';
              return;
            }
            await logout();
            show_toast('access denied');
          }
          document.getElementById('login-btn').style.display = 'block';
          document.getElementById('logout-btn').style.display = 'none';
          document.getElementById('editor').style.display = 'none';
        } catch (e) {
          console.error('ui update error:', e);
        }
      }

      async function login() {
        await auth0client.loginWithRedirect({ authorizationParams: { redirect_uri: window.location.origin } });
      }

      async function logout() {
        try {
          const db = firebase.database();
          db.ref('drafts/sharvesh').remove();
          if (currentdraft) {
            await db.ref(`posts/${currentdraft}`).remove();
            currentdraft = null;
          }
          db.ref('typingstatus').set({ iswriting: false, timestamp: Date.now() });
          await auth0client.logout({ logoutParams: { returnTo: window.location.origin } });
        } catch (e) {
          console.error("logout error:", e);
        }
      }

      async function publish_post(final = false) {
        try {
          const isauthenticated = await auth0client.isAuthenticated();
          const user = await auth0client.getUser();
          if (!isauthenticated || user.email !== "sharvenium@gmail.com") {
            show_toast('access denied');
            return;
          }
          const input = document.getElementById('post-input');
          const content = input.value.trim();
          if (!content) {
            show_toast('cannot publish empty decree');
            return;
          }
          const db = firebase.database();
          if (final) {
            db.ref('drafts/sharvesh').remove();
            if (currentdraft) {
              await db.ref(`posts/${currentdraft}`).remove();
              currentdraft = null;
            }
            await db.ref('posts').push({
              content: content,
              timestamp: Date.now(),
              isdraft: false,
              wordcount: count_words(content)
            });
            input.value = '';
            document.getElementById('char-count').textContent = '0 characters';
            document.getElementById('live-draft-preview').innerHTML = '';
            document.getElementById('save-status').textContent = '';
            show_toast('decree published');
            show_live_indicator(false);
            db.ref('typingstatus').set({ iswriting: false, timestamp: Date.now() });
          }
        } catch (e) {
          console.error("publish error:", e);
          show_toast('error publishing decree');
        }
      }

      function count_words(text) {
        return text.trim().split(/\s+/).length;
      }

      async function delete_post(postid) {
        try {
          const isauthenticated = await auth0client.isAuthenticated();
          const user = await auth0client.getUser();
          if (!isauthenticated || user.email !== "sharvenium@gmail.com") {
            show_toast('access denied');
            return;
          }
          if (!confirm('delete this decree?')) return;
          const db = firebase.database();
          await db.ref(`posts/${postid}`).remove();
          show_toast('decree deleted');
        } catch (e) {
          console.error("delete error:", e);
          show_toast('error deleting decree');
        }
      }

      function search_posts(query) {
        query = query.toLowerCase();
        if (!query) {
          render_posts(posts);
          return;
        }
        const filtered = posts.filter(([key, post]) => post.content.toLowerCase().includes(query));
        render_posts(filtered);
      }

      async function render_post(key, post, timeline) {
        const dateobj = new Date(post.timestamp);
        const timeStr = dateobj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const dateStr = dateobj.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
        const formatted = `${dateStr}, ${timeStr}`;
        const postel = document.createElement('div');
        postel.className = 'post';
        postel.id = `post-${key}`;
        const isauthenticated = await auth0client.isAuthenticated();
        const user = isauthenticated ? await auth0client.getUser() : null;
        const isadmin = isauthenticated && user && user.email === "sharvenium@gmail.com";
        postel.innerHTML = `
          <div class="post-header">
            <div class="timestamp">${formatted}</div>
            ${isadmin ? `<div class="post-actions">
              <button onclick="delete_post('${key}')" title="delete decree">delete</button>
            </div>` : ''}
          </div>
          <div class="post-content">${marked.parse(post.content)}</div>
        `;
        postel.querySelectorAll('pre code').forEach(block => {
          hljs.highlightElement(block);
        });
        timeline.appendChild(postel);
      }

      function load_posts() {
        const db = firebase.database();
        db.ref('posts').on('value', async (snapshot) => {
          const timeline = document.getElementById('timeline');
          timeline.innerHTML = '';
          const postsdata = snapshot.val();
          if (!postsdata) {
            show_empty_state();
            update_stats_count();
            return;
          }
          posts = Object.entries(postsdata)
            .filter(([, post]) => !post.isdraft)
            .sort(([, a], [, b]) => b.timestamp - a.timestamp);
          update_stats_count();
          render_posts(posts);
        });
      }

      function show_empty_state() {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = `<div class="empty-state" style="text-align:center; padding:40px 0; color:var(--subtle)"><p>no decrees yet</p></div>`;
      }

      function render_posts(postslist) {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '';
        if (postslist.length === 0) {
          if (searchactive && document.getElementById('search-input').value) {
            timeline.innerHTML = `<div class="empty-state" style="text-align:center; padding:40px 0; color:var(--subtle)"><p>no decrees matching your search</p></div>`;
          } else {
            show_empty_state();
          }
          return;
        }
        postslist.forEach(postdata => {
          render_post(postdata[0], postdata[1], timeline);
        });
      }

      function update_stats_count() {
        const total = posts.length;
        const todayCount = posts.filter(([, p]) => new Date(p.timestamp).toDateString() === new Date().toDateString()).length;
        let totalwords = 0;
        posts.forEach(([, post]) => {
          if (post.wordcount) {
            totalwords += post.wordcount;
          } else {
            totalwords += count_words(post.content);
          }
        });
        document.getElementById('total-posts').textContent = `total posts: ${total}`;
        document.getElementById('today-posts').textContent = `posts today: ${todayCount}`;
        document.getElementById('word-count').textContent = `total words: ${totalwords}`;
      }

      function toggle_theme() {
        isdark = !isdark;
        document.documentElement.setAttribute('data-theme', isdark ? 'dark' : 'light');
        document.getElementById('theme-toggle').textContent = isdark ? '☀️' : '🌙';
        localStorage.setItem('theme', isdark ? 'dark' : 'light');
      }

      function show_toast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
      }

      function handle_direct_links() {
        const hash = window.location.hash;
        if (hash && hash.length > 1) {
          const postid = hash.substring(1);
          setTimeout(() => {
            const el = document.getElementById(`post-${postid}`);
            if (el) {
              el.scrollIntoView({ behavior: 'smooth' });
              el.style.boxShadow = '0 0 0 2px var(--primary)';
              setTimeout(() => { el.style.boxShadow = ''; }, 2000);
            }
          }, 500);
        }
      }

      function setup_keyboard_shortcuts() {
        document.addEventListener('keydown', async (e) => {
          const isauthenticated = await auth0client.isAuthenticated();
          const user = isauthenticated ? await auth0client.getUser() : null;
          const isadmin = isauthenticated && user && user.email === "sharvenium@gmail.com";
          if (isadmin && e.key === 'enter' && (e.metaKey || e.ctrlKey)) {
            publish_post(true);
            e.preventDefault();
          }
          if (e.key === 'escape' && searchactive) {
            clear_search();
            toggle_search();
          }
          if (e.key === '/' && !searchactive && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
            toggle_search();
            e.preventDefault();
          }
        });
      }

      document.getElementById('login-btn').onclick = login;
      document.getElementById('logout-btn').onclick = logout;

      window.onload = async () => {
        await init_auth0();
        init_firebase();
        init_presence();
        setup_typing_listener();
        init_draft_viewer();
        setup_keyboard_shortcuts();
        handle_direct_links();
      };
    </script>
  </body>
</html>
