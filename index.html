<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>sharvesh's posts</title>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <link rel="icon" type="image/png" href="icon.png">
    <style>
      :root {
        --bg: #ffffff;
        --text: #333333;
        --subtle: #e0e0e0;
        --primary: #0055aa;
        --secondary-bg: #f8f8f8;
        --hover: rgba(0,85,170,0.1);
        --code-bg: #f4f4f4;
      }
      [data-theme="dark"] {
        --bg: #1d1d1d;
        --text: #dddddd;
        --subtle: #333333;
        --primary: #77aaff;
        --secondary-bg: #2a2a2a;
        --hover: rgba(119,170,255,0.15);
        --code-bg: #2e2e2e;
      }
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body {
        font-family: sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: var(--bg);
        color: var(--text);
        transition: all 0.3s;
      }
      header {
        padding: 10px 0;
        border-bottom: 1px solid var(--subtle);
        margin-bottom: 20px;
      }
      header h1 {
        font-size: 24px;
        color: var(--primary);
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      nav ul {
        list-style: none;
        display: flex;
        gap: 15px;
      }
      nav ul li a {
        text-decoration: none;
        color: var(--primary);
      }
      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .controls button {
        background: none;
        border: 1px solid var(--subtle);
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .controls button:hover { background: var(--hover); }
      .search-container {
        position: relative;
        display: none;
      }
      #searchinput {
        padding: 6px 30px 6px 10px;
        border: 1px solid var(--subtle);
        border-radius: 4px;
        width: 200px;
      }
      #searchinput:focus { outline: none; border-color: var(--primary); }
      .clear-search {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        color: var(--text);
      }
      .bio {
        padding: 15px;
        border: 1px solid var(--subtle);
        border-radius: 4px;
        background: var(--secondary-bg);
        margin-bottom: 20px;
      }
      .bio p { margin-bottom: 10px; }
      .bio-toggle {
        background: none;
        border: none;
        color: var(--primary);
        cursor: pointer;
        font-size: 14px;
      }
      .stats {
        font-size: 14px;
        color: var(--text);
        margin-bottom: 20px;
        display: flex;
        gap: 20px;
      }
      #editor {
        display: none;
        margin-bottom: 20px;
      }
      #editor textarea {
        width: 100%;
        height: 150px;
        padding: 10px;
        border: 1px solid var(--subtle);
        border-radius: 4px;
        font-family: inherit;
        font-size: 14px;
        background: var(--bg);
        color: var(--text);
        resize: vertical;
      }
      #editor textarea:focus { outline: none; border-color: var(--primary); }
      .editor-actions {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .editor-actions button {
        background: var(--primary);
        border: none;
        color: #ffffff;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
      }
      .draft-preview {
        border: 1px dashed var(--subtle);
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
        background: var(--secondary-bg);
      }
      .post {
        border: 1px solid var(--subtle);
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
        background: var(--secondary-bg);
      }
      .post-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 14px;
      }
      .post-header button {
        background: none;
        border: 1px solid var(--subtle);
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
      }
      .post-content p {
        margin-bottom: 1em;
        line-height: 1.6;
      }
      .post-content pre {
        background: var(--code-bg);
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        margin: 10px 0;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--primary);
        color: #ffffff;
        padding: 10px 20px;
        border-radius: 4px;
        display: none;
      }
      .live-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: var(--secondary-bg);
        color: var(--text);
        text-align: center;
        padding: 8px;
        border-bottom: 1px solid var(--subtle);
        display: none;
        z-index: 1000;
      }
      .live-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: var(--primary);
        border-radius: 50%;
        margin-right: 8px;
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0% { opacity: 0.4; }
        50% { opacity: 1; }
        100% { opacity: 0.4; }
      }
      @media (max-width: 700px) {
        body { padding: 15px; }
        #searchinput { width: 160px; }
      }
    </style>
  </head>
  <body>
    <div class="live-bar" id="livebar">
      <span class="live-dot"></span> sharvesh is writing...
    </div>
    <header>
      <h1>sharvesh's posts</h1>
      <nav>
        <ul>
          <li><a href="#">home</a></li>
          <li><a href="#">posts</a></li>
          <li><a href="#">about</a></li>
        </ul>
        <div class="controls">
          <button onclick="togglesearch()" title="search posts">üîç</button>
          <div class="search-container" id="searchcontainer">
            <input type="text" id="searchinput" placeholder="search posts..." onkeyup="searchposts(this.value)">
            <button class="clear-search" onclick="clearsearch()" title="clear search">‚úï</button>
          </div>
          <button onclick="toggletheme()" id="themetoggle" title="toggle theme">üåô</button>
          <button id="loginbtn" onclick="login()" title="admin login">login</button>
          <button id="logoutbtn" onclick="logout()" title="logout" style="display:none">logout</button>
        </div>
      </nav>
    </header>
    <section class="bio">
      <p>contributor. writing at <a href="https://www.sharvesh.com/" target="_blank">sharvesh.com</a></p>
      <button class="bio-toggle" onclick="togglebio()" id="biotoggle">more ‚ñº</button>
      <div class="bio-content" id="biocontent" style="display:none">
        <h2>favorite reads</h2>
        <ul>
          <li>elon musk, steve jobs, kissinger - walter isaacson</li>
          <li>the years of lyndon johnson - robert caro</li>
          <li>napoleon - andrew roberts</li>
          <li>alexander hamilton, titan - ron chernow</li>
          <li>the patriarch - david nasaw</li>
          <li>the theodore roosevelt trilogy - edmund morris</li>
          <li>total recall - arnold schwarzenegger</li>
          <li>the singapore story - lee kuan yew</li>
          <li>hpmor - eliezer yudkowsky</li>
        </ul>
        <h4>@sharvenium</h4>
      </div>
    </section>
    <div class="stats">
      <span id="totalposts">total posts: 0</span>
      <span id="todayposts">posts today: 0</span>
      <span id="wordcount">total words: 0</span>
    </div>
    <section id="editor">
      <textarea id="postinput" placeholder="what's on your mind? markdown supported..." oninput="handletyping(event)"></textarea>
      <div class="editor-actions">
        <span id="charcount">0 characters</span>
        <button onclick="publishpost(true)">publish</button>
      </div>
      <div class="draft-preview">
        <div class="draft-header">
          <span>live preview</span>
          <span id="savestatus"></span>
        </div>
        <div id="livedraftpreview"></div>
      </div>
    </section>
    <section id="timeline"></section>
    <div class="toast" id="toast"></div>
    <script>
      let auth0client = null;
      let posts = [];
      let isdark = localStorage.getItem('theme') === 'dark';
      let currentdraft = null;
      let typingtimeout = null;
      let liveindicatortimeout = null;
      let searchactive = false;
      if (isdark) {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themetoggle').textContent = '‚òÄÔ∏è';
      }
      marked.setOptions({
        breaks: true,
        gfm: true,
        highlight: function(code, lang) {
          if (hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
          }
          return code;
        }
      });
      function togglesearch() {
        const container = document.getElementById('searchcontainer');
        searchactive = !searchactive;
        container.style.display = searchactive ? 'block' : 'none';
        if (searchactive) {
          document.getElementById('searchinput').focus();
        } else {
          clearsearch();
        }
      }
      function clearsearch() {
        document.getElementById('searchinput').value = '';
        searchposts('');
      }
      function togglebio() {
        const bio = document.getElementById('biocontent');
        const btn = document.getElementById('biotoggle');
        if (bio.style.display === 'block') {
          bio.style.display = 'none';
          btn.innerHTML = 'more ‚ñº';
        } else {
          bio.style.display = 'block';
          btn.innerHTML = 'less ‚ñ≤';
        }
      }
      function showliveindicator(show) {
        const livebar = document.getElementById('livebar');
        livebar.style.display = show ? 'block' : 'none';
        document.body.classList.toggle('live-mode', show);
      }
      function initpresence() {
        const db = firebase.database();
        const userref = db.ref('presence/sharvesh');
        const offline = { state: 'offline', lastchanged: firebase.database.ServerValue.TIMESTAMP };
        const online = { state: 'online', lastchanged: firebase.database.ServerValue.TIMESTAMP };
        auth0client.isAuthenticated().then(isauthenticated => {
          if (isauthenticated) {
            auth0client.getUser().then(user => {
              if (user.email === "sharvenium@gmail.com") {
                db.ref('.info/connected').on('value', snap => {
                  if (!snap.val()) {
                    userref.set(offline);
                    return;
                  }
                  userref.onDisconnect().set(offline).then(() => { userref.set(online); });
                });
              }
            });
          }
        });
        userref.on('value', snapshot => {
          const val = snapshot.val();
          if (!val) return;
        });
      }
      function initdraftviewer() {
        const db = firebase.database();
        db.ref('drafts/sharvesh').on('value', snapshot => {
          const data = snapshot.val();
          const draftel = document.getElementById('livedraftpreview');
          const savestatus = document.getElementById('savestatus');
          if (!data) { draftel.innerHTML = ''; savestatus.textContent = ''; return; }
          draftel.innerHTML = marked.parse(data.content);
          draftel.querySelectorAll('pre code').forEach(block => { hljs.highlightElement(block); });
          const now = new Date();
          const timestamp = new Date(data.timestamp);
          const diff = Math.floor((now - timestamp) / 1000);
          if (diff < 60) { savestatus.textContent = `saved ${diff}s ago`; }
          else { savestatus.textContent = `saved at ${timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`; }
        });
      }
      async function handletyping(event) {
        const isauthenticated = await auth0client.isAuthenticated();
        if (!isauthenticated) return;
        const charcount = document.getElementById('charcount');
        charcount.textContent = `${event.target.value.length} characters`;
        clearTimeout(typingtimeout);
        clearTimeout(liveindicatortimeout);
        const db = firebase.database();
        db.ref('typingstatus').set({ iswriting: true, timestamp: Date.now() });
        const newcontent = event.target.value;
        db.ref('drafts/sharvesh').set({ content: newcontent, timestamp: Date.now() });
        typingtimeout = setTimeout(async () => {
          const content = newcontent.trim();
          if (!content) {
            db.ref('drafts/sharvesh').remove();
            if (currentdraft) { await db.ref(`posts/${currentdraft}`).remove(); currentdraft = null; }
            db.ref('typingstatus').set({ iswriting: false, timestamp: Date.now() });
            return;
          }
          if (!currentdraft) {
            const ref = await db.ref('posts').push({ content, timestamp: Date.now(), isdraft: true });
            currentdraft = ref.key;
          } else {
            await db.ref(`posts/${currentdraft}`).update({ content, timestamp: Date.now() });
          }
          db.ref('typingstatus').set({ iswriting: false, timestamp: Date.now() });
        }, 1000);
        liveindicatortimeout = setTimeout(() => {
          db.ref('typingstatus').set({ iswriting: false, timestamp: Date.now() });
        }, 5000);
      }
      function setuptypinglistener() {
        const db = firebase.database();
        db.ref('typingstatus').on('value', snapshot => {
          const status = snapshot.val();
          if (!status) return;
          showliveindicator(status.iswriting);
        });
      }
      async function initauth0() {
        try {
          auth0client = await auth0.createAuth0Client({
            domain: 'dev-kaixuri5eyviz2vm.us.auth0.com',
            clientId: 'z97keo08fomauocmmopfglaib0obi1k2',
            authorizationParams: { redirect_uri: window.location.origin }
          });
          if (window.location.search.includes("code=")) {
            await auth0client.handleRedirectCallback();
            window.history.replaceState({}, document.title, window.location.pathname);
          }
          updateui();
        } catch (e) {
          console.error("auth0 init error:", e);
          showtoast("authentication error");
        }
      }
      function initfirebase() {
        const firebaseconfig = {
          apiKey: "AIzaSyASOSvCtoOddTRUdqzxVtCBcyfJ82SsEc0",
          authDomain: "twitterblog-9e7ea.firebaseapp.com",
          databaseURL: "https://twitterblog-9e7ea-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "twitterblog-9e7ea",
          storageBucket: "twitterblog-9e7ea.firebasestorage.app",
          messagingSenderId: "564254133364",
          appId: "1:564254133364:web:e89a32517db54517369521"
        };
        firebase.initializeApp(firebaseconfig);
        loadposts();
      }
      async function updateui() {
        try {
          const isauthenticated = await auth0client.isAuthenticated();
          if (isauthenticated) {
            const user = await auth0client.getUser();
            console.log('logged in as:', user.email);
            if (user.email === "sharvenium@gmail.com") {
              document.getElementById('loginbtn').style.display = 'none';
              document.getElementById('logoutbtn').style.display = 'block';
              document.getElementById('editor').style.display = 'block';
              return;
            }
            await logout();
            showtoast('access denied');
          }
          document.getElementById('loginbtn').style.display = 'block';
          document.getElementById('logoutbtn').style.display = 'none';
          document.getElementById('editor').style.display = 'none';
        } catch (e) {
          console.error('ui update error:', e);
        }
      }
      async function login() {
        await auth0client.loginWithRedirect({ authorizationParams: { redirect_uri: window.location.origin } });
      }
      async function logout() {
        try {
          const db = firebase.database();
          db.ref('drafts/sharvesh').remove();
          if (currentdraft) { await db.ref(`posts/${currentdraft}`).remove(); currentdraft = null; }
          db.ref('typingstatus').set({ iswriting: false, timestamp: Date.now() });
          await auth0client.logout({ logoutParams: { returnTo: window.location.origin } });
        } catch (e) {
          console.error("logout error:", e);
        }
      }
      async function publishpost(final = false) {
        try {
          const isauthenticated = await auth0client.isAuthenticated();
          const user = await auth0client.getUser();
          if (!isauthenticated || user.email !== "sharvenium@gmail.com") {
            showtoast('access denied');
            return;
          }
          const input = document.getElementById('postinput');
          const content = input.value.trim();
          if (!content) {
            showtoast('cannot publish empty post');
            return;
          }
          const db = firebase.database();
          if (final) {
            db.ref('drafts/sharvesh').remove();
            if (currentdraft) { await db.ref(`posts/${currentdraft}`).remove(); currentdraft = null; }
            await db.ref('posts').push({
              content,
              timestamp: Date.now(),
              isdraft: false,
              wordcount: countwords(content)
            });
            input.value = '';
            document.getElementById('charcount').textContent = '0 characters';
            document.getElementById('livedraftpreview').innerHTML = '';
            document.getElementById('savestatus').textContent = '';
            showtoast('post published');
            showliveindicator(false);
            db.ref('typingstatus').set({ iswriting: false, timestamp: Date.now() });
          }
        } catch (e) {
          console.error("publish error:", e);
          showtoast('error publishing post');
        }
      }
      function countwords(text) {
        return text.trim().split(/\s+/).length;
      }
      async function deletepost(postid) {
        try {
          const isauthenticated = await auth0client.isAuthenticated();
          const user = await auth0client.getUser();
          if (!isauthenticated || user.email !== "sharvenium@gmail.com") {
            showtoast('access denied');
            return;
          }
          if (!confirm('delete this post?')) return;
          const db = firebase.database();
          await db.ref(`posts/${postid}`).remove();
          showtoast('post deleted');
        } catch (e) {
          console.error("delete error:", e);
          showtoast('error deleting post');
        }
      }
      function searchposts(query) {
        query = query.toLowerCase();
        if (!query) { renderposts(posts); return; }
        const filtered = posts.filter(([key, post]) => post.content.toLowerCase().includes(query));
        renderposts(filtered);
      }
      async function renderpost(key, post, timeline) {
        const date = new Date(post.timestamp);
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const dateStr = date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
        const formatted = `${dateStr}, ${timeStr}`;
        const postel = document.createElement('div');
        postel.className = 'post';
        postel.id = `post-${key}`;
        const isauthenticated = await auth0client.isAuthenticated();
        const user = isauthenticated ? await auth0client.getUser() : null;
        const isadmin = isauthenticated && user && user.email === "sharvenium@gmail.com";
        postel.innerHTML = `
          <div class="post-header">
            <div class="timestamp">${formatted}</div>
            ${isadmin ? `<button onclick="deletepost('${key}')" title="delete post">delete</button>` : ''}
          </div>
          <div class="post-content">${marked.parse(post.content)}</div>
        `;
        postel.querySelectorAll('pre code').forEach(block => { hljs.highlightElement(block); });
        timeline.appendChild(postel);
      }
      function loadposts() {
        const db = firebase.database();
        db.ref('posts').on('value', async (snapshot) => {
          const timeline = document.getElementById('timeline');
          timeline.innerHTML = '';
          const postsdata = snapshot.val();
          if (!postsdata) { showemptystate(); updateStats(0, 0, 0); return; }
          posts = Object.entries(postsdata)
            .filter(([, post]) => !post.isdraft)
            .sort(([, a], [, b]) => b.timestamp - a.timestamp);
          updatestatscount();
          renderposts(posts);
        });
      }
      function showemptystate() {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = `<div style="text-align:center; padding:40px 0; color:var(--text)">no posts yet</div>`;
      }
      function renderposts(postArray) {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '';
        if (postArray.length === 0) {
          if (searchactive && document.getElementById('searchinput').value) {
            timeline.innerHTML = `<div style="text-align:center; padding:40px 0; color:var(--text)">no posts matching your search</div>`;
          } else {
            showemptystate();
          }
          return;
        }
        postArray.forEach(postdata => { renderpost(postdata[0], postdata[1], timeline); });
      }
      function updatestatscount() {
        const total = posts.length;
        const todayCount = posts.filter(([, p]) => new Date(p.timestamp).toDateString() === new Date().toDateString()).length;
        let totalWords = 0;
        posts.forEach(([, post]) => { totalWords += post.wordcount || countwords(post.content); });
        document.getElementById('totalposts').textContent = `total posts: ${total}`;
        document.getElementById('todayposts').textContent = `posts today: ${todayCount}`;
        document.getElementById('wordcount').textContent = `total words: ${totalWords}`;
      }
      function toggletheme() {
        isdark = !isdark;
        document.documentElement.setAttribute('data-theme', isdark ? 'dark' : 'light');
        document.getElementById('themetoggle').textContent = isdark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', isdark ? 'dark' : 'light');
      }
      function showtoast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
      }
      function handledirectlinks() {
        const hash = window.location.hash;
        if (hash && hash.length > 1) {
          const postid = hash.substring(1);
          setTimeout(() => {
            const el = document.getElementById(`post-${postid}`);
            if (el) {
              el.scrollIntoView({ behavior: 'smooth' });
              el.style.boxShadow = '0 0 0 2px var(--primary)';
              setTimeout(() => { el.style.boxShadow = ''; }, 2000);
            }
          }, 500);
        }
      }
      function setupkeyboardshortcuts() {
        document.addEventListener('keydown', async (e) => {
          const isauthenticated = await auth0client.isAuthenticated();
          const user = isauthenticated ? await auth0client.getUser() : null;
          const isadmin = isauthenticated && user && user.email === "sharvenium@gmail.com";
          if (isadmin && e.key === 'enter' && (e.metaKey || e.ctrlKey)) { publishpost(true); e.preventDefault(); }
          if (e.key === 'escape' && searchactive) { clearsearch(); togglesearch(); }
          if (e.key === '/' && !searchactive && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') { togglesearch(); e.preventDefault(); }
        });
      }
      document.getElementById('loginbtn').onclick = login;
      document.getElementById('logoutbtn').onclick = logout;
      window.onload = async () => {
        await initauth0();
        initfirebase();
        initpresence();
        setuptypinglistener();
        initdraftviewer();
        setupkeyboardshortcuts();
        handledirectlinks();
      };
    </script>
  </body>
</html>
